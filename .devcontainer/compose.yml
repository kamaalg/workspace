services:
  dev:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ../:/workspace
      - ${HOME}/.config/gcloud:/root/.config/gcloud:ro
    command: /bin/sh -c "sleep infinity"
    user: root
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DB_URL=postgresql+psycopg://app:app@postgres:5432/app
      - PIP_DISABLE_PIP_VERSION_CHECK=1
      - PYTHONUNBUFFERED=1
      - GOOGLE_APPLICATION_CREDENTIALS=/root/.config/gcloud/application_default_credentials.json

    ports:
      - "8001:8000"

  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=app
      - POSTGRES_DB=app
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-app} -d ${POSTGRES_DB:-app} -h localhost"]
      interval: 3s
      timeout: 5s
      retries: 20
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5433:5432"

  airflow:
    image: apache/airflow:2.9.3-python3.12   
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://app:app@host.docker.internal:5433/app
      AIRFLOW__WEBSERVER__SECRET_KEY: changeme
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
    volumes:
      - ./dags:/opt/airflow/dags
      - ./logs:/opt/airflow/logs
      - ./plugins:/opt/airflow/plugins
      - ./requirements.txt:/opt/airflow/requirements.txt
    user: "${AIRFLOW_UID:-50000}:0"
    ports:
      - "8080:8080"
    command: ["bash","-lc",
      "airflow db migrate && \
       airflow users create --username admin --password admin --firstname Admin --lastname User --role Admin --email admin@example.com || true; \
       exec airflow webserver --port 8080"
    ]




volumes:
  pgdata:
    external: true
    name: fastapi-pg-dev_devcontainer_pgdata
